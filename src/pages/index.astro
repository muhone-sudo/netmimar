---
export const prerender = true;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getReader } from "../lib/reader";

// Keystatic reader
const reader = getReader();

// Veri çek
let settings: any = null;
let homepage: any = null;
let services: any[] = [];
let projects: any[] = [];
let blogPosts: any[] = [];
let teamMembers: any[] = [];

try {
  settings = await reader.singletons.settings.read();
  homepage = await reader.singletons.homepage.read();

  const servicesRaw = await reader.collections.services.all();
  services = servicesRaw.map((s) => ({ slug: s.slug, ...s.entry }));

  const projectsRaw = await reader.collections.projects.all();
  projects = projectsRaw.map((p) => ({ slug: p.slug, ...p.entry }));

  const blogRaw = await reader.collections.blog.all();
  blogPosts = blogRaw
    .map((b) => ({ slug: b.slug, ...b.entry }))
    .sort(
      (a: any, b: any) =>
        new Date(b.date || 0).getTime() - new Date(a.date || 0).getTime()
    )
    .slice(0, 3);

  const teamRaw = await reader.collections.team.all();
  teamMembers = teamRaw
    .map((t) => ({ slug: t.slug, ...t.entry }))
    .sort((a: any, b: any) => (a.order || 0) - (b.order || 0));
} catch (e) {
  console.warn("Reader warning:", e);
}

// Değerler
const siteTitle = settings?.siteTitle || "NetMimar";
const slogan = settings?.slogan || "Profesyonel Web Çözümleri";
const metaDesc = settings?.metaDescription || "";

const heroHeading = homepage?.heroHeading || "Dijital Dünyada Fark Yaratın";
const heroSubheading =
  homepage?.heroSubheading ||
  "İşletmenizi profesyonel web çözümleri ile büyütün.";
const heroCtaText = homepage?.heroCtaText || "Hemen Başlayın";
const heroCtaLink = homepage?.heroCtaLink || "#iletisim";
const heroBackground = homepage?.heroBackgroundImage || null;
const features = homepage?.features || [];
const counters = homepage?.counters || [];
const testimonials = homepage?.testimonials || [];
---

<BaseLayout title={`${siteTitle} — ${slogan}`} description={metaDesc}>
  <!-- HERO SECTION -->
  <section
    class="relative overflow-hidden"
    style={`min-height: 85vh; background: ${
      heroBackground
        ? `url(${heroBackground}) center/cover no-repeat`
        : "linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%)"
    };`}
  >
    {
      heroBackground && (
        <div class="absolute inset-0" style="background: rgba(15,23,42,0.7);" />
      )
    }
    <!-- Decorative -->
    <div class="absolute inset-0 overflow-hidden">
      <div
        class="absolute -top-40 -right-40 w-96 h-96 rounded-full opacity-10"
        style="background: radial-gradient(circle, #3b82f6, transparent);"
      >
      </div>
      <div
        class="absolute -bottom-40 -left-40 w-96 h-96 rounded-full opacity-10"
        style="background: radial-gradient(circle, #60a5fa, transparent);"
      >
      </div>
    </div>

    <div
      class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center"
      style="min-height: 85vh;"
    >
      <div class="max-w-3xl animate-slide-up">
        <div
          class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium mb-6"
          style="background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.2);"
        >
          ✨ {slogan}
        </div>
        <h1
          class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-white leading-tight mb-6"
        >
          {heroHeading}
        </h1>
        <p
          class="text-lg sm:text-xl mb-8"
          style="color: #94a3b8; max-width: 600px;"
        >
          {heroSubheading}
        </p>
        <div class="flex flex-wrap gap-4">
          <a
            href={heroCtaLink}
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white transition-all duration-300"
            style="background: linear-gradient(135deg, #3b82f6, #2563eb);"
          >
            {heroCtaText}
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
          <a
            href="/hizmetler"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all duration-300"
            style="color: #94a3b8; border: 1px solid rgba(148,163,184,0.3);"
          >
            Hizmetleri Keşfet
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- FEATURES / NEDEN BIZ SECTION -->
  {
    features.length > 0 && (
      <section class="py-20 bg-surface-dark">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">
              Neden Biz?
            </h2>
            <p class="text-text-muted max-w-2xl mx-auto">
              İşletmenizin dijital dönüşümü için ihtiyacınız olan her şey.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {features.map((feature: any) => (
              <div class="bg-surface rounded-2xl p-6 border border-border transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                <div
                  class="w-12 h-12 rounded-xl flex items-center justify-center mb-4"
                  style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(96,165,250,0.1));"
                >
                  <span class="text-2xl">{feature.iconClass || "⚡"}</span>
                </div>
                <h3 class="text-lg font-semibold text-primary mb-2">
                  {feature.title}
                </h3>
                <p class="text-text-muted text-sm">{feature.description}</p>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- HIZMETLER SECTION -->
  {
    services.length > 0 && (
      <section id="hizmetler" class="py-20 bg-surface">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">
              Hizmetlerimiz
            </h2>
            <p class="text-text-muted max-w-2xl mx-auto">
              Size en iyi hizmeti sunmak için buradayız.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {services.map((service: any) => (
              <a
                href={`/hizmetler/${service.slug}`}
                class="group bg-surface rounded-2xl border border-border overflow-hidden transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
              >
                {service.featuredImage && (
                  <div class="aspect-video overflow-hidden">
                    <img
                      src={service.featuredImage}
                      alt={service.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    />
                  </div>
                )}
                <div class="p-6">
                  <h3 class="text-lg font-semibold text-primary mb-2 group-hover:text-accent transition-colors">
                    {service.title}
                  </h3>
                  <p class="text-text-muted text-sm">
                    {service.shortDescription}
                  </p>
                  <span class="inline-flex items-center gap-1 text-accent text-sm font-medium mt-3">
                    Detaylar{" "}
                    <svg
                      class="w-3 h-3"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  </span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- COUNTERS SECTION -->
  {
    counters.length > 0 && (
      <section
        class="py-16"
        style="background: linear-gradient(135deg, #0f172a, #1e293b);"
      >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
            {counters.map((counter: any) => (
              <div>
                <div
                  class="text-3xl sm:text-4xl font-extrabold mb-1"
                  style="background: linear-gradient(135deg, #3b82f6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"
                >
                  {counter.number}
                </div>
                <div class="text-sm" style="color: #94a3b8;">
                  {counter.label}
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- PROJELER SECTION -->
  {
    projects.length > 0 && (
      <section id="projeler" class="py-20 bg-surface-dark">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">
              Projelerimiz
            </h2>
            <p class="text-text-muted max-w-2xl mx-auto">
              Tamamladığımız projelere göz atın.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {projects.map((project: any) => (
              <a
                href={`/projeler/${project.slug}`}
                class="group bg-surface rounded-2xl border border-border overflow-hidden transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
              >
                {project.coverImage && (
                  <div class="aspect-video overflow-hidden">
                    <img
                      src={project.coverImage}
                      alt={project.projectName}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    />
                  </div>
                )}
                <div class="p-6">
                  <h3 class="text-lg font-semibold text-primary mb-1 group-hover:text-accent transition-colors">
                    {project.projectName}
                  </h3>
                  {project.category && (
                    <span
                      class="inline-block text-xs font-medium px-2 py-0.5 rounded-full mb-2"
                      style="background: rgba(59,130,246,0.1); color: #3b82f6;"
                    >
                      {project.category}
                    </span>
                  )}
                  {project.client && (
                    <p class="text-text-muted text-sm">
                      Müşteri: {project.client}
                    </p>
                  )}
                </div>
              </a>
            ))}
          </div>
          <div class="text-center mt-10">
            <a
              href="/projeler"
              class="inline-flex items-center gap-2 text-accent font-semibold hover:underline"
            >
              Tüm Projeler{" "}
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"
                />
              </svg>
            </a>
          </div>
        </div>
      </section>
    )
  }

  <!-- TESTIMONIALS SECTION -->
  {
    testimonials.length > 0 && (
      <section class="py-20 bg-surface">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">
              Müşterilerimiz Ne Diyor?
            </h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {testimonials.map((t: any) => (
              <div class="bg-surface-dark rounded-2xl p-6 border border-border">
                <div class="flex items-center gap-3 mb-4">
                  {t.clientPhoto ? (
                    <img
                      src={t.clientPhoto}
                      alt={t.clientName}
                      class="w-12 h-12 rounded-full object-cover"
                    />
                  ) : (
                    <div
                      class="w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold"
                      style="background: linear-gradient(135deg, #3b82f6, #60a5fa);"
                    >
                      {t.clientName?.charAt(0) || "?"}
                    </div>
                  )}
                  <div>
                    <div class="font-semibold text-primary">{t.clientName}</div>
                    {t.clientRole && (
                      <div class="text-xs text-text-muted">{t.clientRole}</div>
                    )}
                  </div>
                </div>
                <p class="text-text-muted text-sm italic">"{t.quote}"</p>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- BLOG SECTION -->
  {
    blogPosts.length > 0 && (
      <section id="blog" class="py-20 bg-surface-dark">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">
              Blogumuz
            </h2>
            <p class="text-text-muted max-w-2xl mx-auto">
              En son yazılarımıza göz atın.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {blogPosts.map((post: any) => (
              <a
                href={`/blog/${post.slug}`}
                class="group bg-surface rounded-2xl border border-border overflow-hidden transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
              >
                {post.coverImage && (
                  <div class="aspect-video overflow-hidden">
                    <img
                      src={post.coverImage}
                      alt={post.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    />
                  </div>
                )}
                <div class="p-6">
                  {post.category && (
                    <span
                      class="inline-block text-xs font-medium px-2 py-0.5 rounded-full mb-2"
                      style="background: rgba(59,130,246,0.1); color: #3b82f6;"
                    >
                      {post.category}
                    </span>
                  )}
                  <h3 class="text-lg font-semibold text-primary mb-2 group-hover:text-accent transition-colors">
                    {post.title}
                  </h3>
                  <div class="flex items-center gap-3 text-xs text-text-muted">
                    {post.date && (
                      <span>
                        {new Date(post.date).toLocaleDateString("tr-TR")}
                      </span>
                    )}
                    {post.author && <span>• {post.author}</span>}
                  </div>
                </div>
              </a>
            ))}
          </div>
          <div class="text-center mt-10">
            <a
              href="/blog"
              class="inline-flex items-center gap-2 text-accent font-semibold hover:underline"
            >
              Tüm Yazılar{" "}
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"
                />
              </svg>
            </a>
          </div>
        </div>
      </section>
    )
  }

  <!-- EKIP SECTION -->
  {
    teamMembers.length > 0 && (
      <section class="py-20 bg-surface">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">
              Ekibimiz
            </h2>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 justify-items-center">
            {teamMembers.map((member: any) => (
              <div class="text-center">
                {member.photo ? (
                  <img
                    src={member.photo}
                    alt={member.name}
                    class="w-28 h-28 rounded-full object-cover mx-auto mb-4 border-2 border-border"
                  />
                ) : (
                  <div
                    class="w-28 h-28 rounded-full flex items-center justify-center text-3xl font-bold text-white mx-auto mb-4"
                    style="background: linear-gradient(135deg, #3b82f6, #60a5fa);"
                  >
                    {member.name?.charAt(0)}
                  </div>
                )}
                <h3 class="font-semibold text-primary">{member.name}</h3>
                <p class="text-sm text-text-muted">{member.role}</p>
              </div>
            ))}
          </div>
          <div class="text-center mt-10">
            <a
              href="/ekip"
              class="inline-flex items-center gap-2 text-accent font-semibold hover:underline"
            >
              Tüm Ekip{" "}
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"
                />
              </svg>
            </a>
          </div>
        </div>
      </section>
    )
  }

  <!-- CONTACT SECTION -->
  <section
    id="iletisim"
    class="py-20"
    style="background: linear-gradient(135deg, #0f172a, #1e293b);"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h2 class="text-3xl sm:text-4xl font-bold text-white mb-4">
          İletişime Geçin
        </h2>
        <p class="max-w-2xl mx-auto" style="color: #94a3b8;">
          Projeniz hakkında konuşmak ister misiniz? Formu doldurun, en kısa
          sürede size dönelim.
        </p>
      </div>

      <div class="max-w-xl mx-auto">
        <form id="contactForm" class="space-y-5">
          <div>
            <label
              for="name"
              class="block text-sm font-medium mb-1"
              style="color: #cbd5e1;">Adınız *</label
            >
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all"
              style="background: rgba(30,41,59,0.8); border: 1px solid rgba(148,163,184,0.2);"
              onfocus="this.style.borderColor='#3b82f6'"
              onblur="this.style.borderColor='rgba(148,163,184,0.2)'"
            />
          </div>
          <div>
            <label
              for="contact-email"
              class="block text-sm font-medium mb-1"
              style="color: #cbd5e1;">E-posta *</label
            >
            <input
              type="email"
              id="contact-email"
              name="email"
              required
              class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all"
              style="background: rgba(30,41,59,0.8); border: 1px solid rgba(148,163,184,0.2);"
              onfocus="this.style.borderColor='#3b82f6'"
              onblur="this.style.borderColor='rgba(148,163,184,0.2)'"
            />
          </div>
          <div>
            <label
              for="phone"
              class="block text-sm font-medium mb-1"
              style="color: #cbd5e1;">Telefon</label
            >
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all"
              style="background: rgba(30,41,59,0.8); border: 1px solid rgba(148,163,184,0.2);"
              onfocus="this.style.borderColor='#3b82f6'"
              onblur="this.style.borderColor='rgba(148,163,184,0.2)'"
            />
          </div>
          <div>
            <label
              for="message"
              class="block text-sm font-medium mb-1"
              style="color: #cbd5e1;">Mesajınız *</label
            >
            <textarea
              id="message"
              name="message"
              rows="4"
              required
              class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all resize-none"
              style="background: rgba(30,41,59,0.8); border: 1px solid rgba(148,163,184,0.2);"
              onfocus="this.style.borderColor='#3b82f6'"
              onblur="this.style.borderColor='rgba(148,163,184,0.2)'"
            ></textarea>
          </div>
          <button
            type="submit"
            id="submitBtn"
            class="w-full py-3 px-4 rounded-xl font-semibold text-white transition-all duration-200 cursor-pointer"
            style="background: linear-gradient(135deg, #3b82f6, #2563eb);"
          >
            Mesaj Gönder
          </button>
          <div
            id="formMessage"
            class="hidden text-center text-sm p-3 rounded-lg"
          >
          </div>
        </form>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  const form = document.getElementById("contactForm") as HTMLFormElement;
  const formMessage = document.getElementById("formMessage") as HTMLDivElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = "Gönderiliyor...";
    formMessage.classList.add("hidden");

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch("/api/contact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      const result = await res.json();

      if (result.success) {
        formMessage.textContent = result.message;
        formMessage.className = "text-center text-sm p-3 rounded-lg";
        formMessage.style.cssText =
          "background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: #6ee7b7;";
        form.reset();
      } else {
        formMessage.textContent =
          result.errors?.join(" ") || "Bir hata oluştu.";
        formMessage.className = "text-center text-sm p-3 rounded-lg";
        formMessage.style.cssText =
          "background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5;";
      }
    } catch {
      formMessage.textContent = "Bağlantı hatası. Lütfen tekrar deneyin.";
      formMessage.className = "text-center text-sm p-3 rounded-lg";
      formMessage.style.cssText =
        "background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5;";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Mesaj Gönder";
      formMessage.classList.remove("hidden");
    }
  });
</script>
